name: Build and Push Docker Image

on:
  push:
    branches: [ main, master ]
    paths:
      - 'JavaApp/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: arc-runner-set
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Build and test with Maven
      run: |
        cd JavaApp
        ./mvnw clean verify
    
    - name: Wait for Docker
      run: |
        echo "Waiting for Docker daemon..."
        for i in {1..30}; do
          if docker info >/dev/null 2>&1; then
            echo "Docker ready!"
            docker info
            break
          fi
          sleep 1
        done
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host
        
    - name: Log in to Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: ./JavaApp
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/spring-boot-app:latest
          ${{ secrets.DOCKER_USERNAME }}/spring-boot-app:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/spring-boot-app:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/spring-boot-app:buildcache,mode=max
    
    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
    
    - name: Update Kubernetes deployment
      run: |
        kubectl set image deployment/spring-boot-app spring-boot-app=${{ secrets.DOCKER_USERNAME }}/spring-boot-app:${{ github.sha }} -n default
        kubectl rollout status deployment/spring-boot-app -n default --timeout=120s
