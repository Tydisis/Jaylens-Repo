name: Build and Push Docker Image

on:
  push:
    branches: [ main, master ]
    paths:
      - 'JavaApp/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: arc-runner-set
    container:
      image: gcr.io/kaniko-project/executor:debug
      options: --user root
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build and push with Kaniko
      shell: sh
      run: |
        echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$(echo -n ${{ secrets.DOCKER_USERNAME }}:${{ secrets.DOCKER_PASSWORD }} | base64)\"}}}" > /kaniko/.docker/config.json
        /kaniko/executor \
          --context=./JavaApp \
          --dockerfile=./JavaApp/Dockerfile \
          --destination=${{ secrets.DOCKER_USERNAME }}/spring-boot-app:latest \
          --destination=${{ secrets.DOCKER_USERNAME }}/spring-boot-app:${{ github.sha }} \
          --cache=true \
          --cache-repo=${{ secrets.DOCKER_USERNAME }}/spring-boot-app-cache
